<!DOCTYPE html>
<html lang="en">
<head><script type='text/javascript' src='https://ppl-ai-code-interpreter-files.s3.amazonaws.com/JOr2UYcmP4tNyUaqKSCFyDAiGQ-OQ9h0nox8OK6e6ZHK0p_leKqwzXqdo3Xv8_WOn5XZJDQ2OSFqJ8QmCEWSuhHVnzG6HNMhI2kdf6AaOYVhPmNcDgGMApHbFQrS7WGapbSruNGyaADsbvs5QTabUpyWxUTEmfKXW3G3J3GY1yvoT_AHj7OsBaLBCdqjlsvMkMl9Hm60Af80Y5kaIsuj6z3vJH1840N7DkEINUTJER94XYy-P8rUw5Oj6yT0BDsl_WTEzZ_xxkCyTsK4H7HGCnQTczFwMnFss2U7J002GLDkKv85-awIcdHfcCUJa67Wo4Mmm3jbkVZMjViuQQceMWlUK8ImOtIQwm7JbrSUE1Psjk6msV7X96DuAGxVO3ebRnGpF23AXxlOuUXTvuq036Mi5yucvVNFt3VM1mgyf-R30Ll4qGtlmnDvEXpu0ujJh7GL47zmXsLNtUGUvnmdFGqDGIWLNbuZkfjdmVmewCybgh8pF7bjryI2rX07ht1DfsIDFPFz_t8LCvmw9ewxY-8xzo6St28OeqVH02WFVVA-_FhrVPdJnWQsFIA3JO58oFr7k2AEIE2nJmIiiB8zxiygcf0GP7XURyCmCK0CvCDT7cmKQ0_ALecjBtOB2mmMPNGXLuvUBQrGTsbojKppwAcFgownUwaFMX1XnbHEa-d_TbrEu9OoENN8cDunkVcN8K8jNyOCpdXEk3uoLg4FMkW6v4EcQ3MMFOfi4BxpCOyAAyPJX8TgvGPnwZF3SXbyWnnAhVqK54tQFlnAT6b6MoArQ0qcDi80VQlRVNGez7d_vPuHKoHM1MqJBPdxKlOIgaPFqEz3dN8NdD2PRXA5kRUxTfQpkWXKmmtSwp7tYoHUZLIr-tg1Si7dxQZx8aIrABly29bthQYOWV45rxsqf3XbXRpkc88QdTr_QHrcNFGTz5tUc-owNWlE5rOBoy1k4HGEMersokyKOSU1qiSBRTXSuz7SgCnWUWs2y741SHhtdleolHwKrNl8uy-9VGf8IhmShP-2ZpyHF5e65lJso710h2sRIbSuhJhjKYumVhcFdFvvBti1E01KTkYo0qrLEc2ly_4Fc-1azafQvhIl0roXjY67vcRoEIBO__tPIwCrAG6L62EPxE16r_dKERg_7K_E6tMtc7BFUpAE_DfmO-6Mba_8oMZG9GUyfK6hvktZNibDkkHSsH2_df_CvJygzbLHlupu5JsBOjiigh6UbhuHeeQ09URjxLw9F2QoQser5BW2nx7cis3w2m5V7wM2cDIG0Va86lCZNHQ_hmuVO822P186ljj0BQlpi1cm6CxB4uh39UOyz46Vtb9MgHo-Y3aGg_Xemk2QwkqJNjHXcourMVTx373oiRbHX-ffG5IXSMKvv87MWuGwcq8aeYKZcP7SF3UHnY4lD4rBvn--GhbejAqYPyXylu33cPiNqQslvbfqrlP-2Iz4lvDSE2vctNViPlV--6S6jl0e9QOmYxyebxLNR_SjVhafYZhZTGitwyTVwqC0NrYO0IzTomebWHHY3ixmn-X0pTCvUP0ygXZaAezGSyq9C5-jeEDhK1cENNEaD6cP5L9P-rnf0UUK7d0zDXi_jA1wTFpk06_KovJwAXGaFcv1slUW4tRDqPb9VTNq_cEtfpzdTbL__M3m0PvCynww5elj4z-VLZEOeDb6E_wwYlveeldfH3EGZqRHCAgEdlWXH1nXyhqM6XPpUae7sZSIcnlVN9c5StNPoX40CkPqgHwxQ4s9Sw1GcJt08a7tP8RLmXQvG3CyInvOpI28tLB7r-ifxUPT1nt4lJFaAtX4hHIWMs_tp88KEAdaaGAD4uhjhFzzUgiI8oanwugFzIDhzn5ASa8BO8_jH1xmvUat-0KuQo80cM-5BeN5DZegzV13X3mNONDWC6TGfkRzoOcLVep3lYVJdQxTTecRZdHjqpuHB9gXP1l4XLlC6KsLOyrUpbpcmbs-UKzYgTnHlG4L_LnxOZLeCwXrSvDAWvc67ZR8QcQPnc1_7dg6VFnyD7dopI7jA1nJ2wdsktuR7bUHEcNewP9twy22v-kWbGDPRzR3Hbb3y7CFQBEwtvFlZ69juy4AyEehXnq9_oYeGthrrK7ZikQFnw7fn0k5OYBf499Pwd8oje0u1NlSeVEywyFIBOoqnUaSIEVHF_A0_7dC0RuBb8DNvPDfRDnQDWrOgmTchZ3NIEIz-b9k0a7NN-Z8w6WSWrle2QHuQqerVHa9Iljq5oMkC8EI9x0zf0fS4nvFzHRpjhSKGVv0RWbURsQY9TvEMeK1nAm6MFIFXmXMXTBoUah2PvkDm4bjrwCCmVF4n1RZnO88Sa0xSY_gwRs9rJFrbAajWHWAJwF4EtVXaACdRsP2g9GajL4JmHrZzKosxP8JrNmdNyRgbxBVIJa5AJDWOBUiZ65MyacK8V09_FVpUQQgFLsxfz--eGg3veT_tOcJsnVyZtc3tqMstqrdwKehs3V7ur5jhRu_ZBf-S1xLyGbwDhaUdaqy_XSQ5dV6dwW7lqLyaxyAT6RD1DLtoOdeThsTvr25IVuQHQ_3kr56eiJ9axLsEB9bNE4c9BU4tlgIj1ObLiRXqgT4EEoj98zrYemR7QkLzt_dDLkEM_2UWrQ4aEIWj75rDsBUgCJD89PDLlA73dkzKQTdy06wr8Id7zum3BDYF-s5bpaATHf8AqOiiLIY5tIgpPrWHiY2O09aAqQT0_I8A28hIXmMhd9bTjL8kFYfRkt4N05JVa6pqcQIrqa2SLmMBk_kPIVpCPskw9FktK-PWtQ6untSENN-ZedCwrfTPw'></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flashcards">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Language Flashcards&quot;,&quot;short_name&quot;:&quot;Flashcards&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;fullscreen&quot;,&quot;background_color&quot;:&quot;#667eea&quot;,&quot;theme_color&quot;:&quot;#667eea&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'&gt;&lt;rect fill='%23667eea' width='192' height='192'/&gt;&lt;text x='96' y='120' font-size='100' fill='white' text-anchor='middle'&gt;üß†&lt;/text&gt;&lt;/svg&gt;&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;,&quot;purpose&quot;:&quot;any&quot;}]}">
    <title>Language Flashcards</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; padding-top: max(20px, env(safe-area-inset-top)); padding-bottom: max(20px, env(safe-area-inset-bottom)); padding-left: max(10px, env(safe-area-inset-left)); padding-right: max(10px, env(safe-area-inset-right)); }
        .container { max-width: 600px; margin: 0 auto; }
        header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; margin-bottom: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 24px; }
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-size: 18px; }
        .nav-btn:active { background: rgba(255,255,255,0.4); }
        .view { display: none; }
        .view.active { display: block; }
        .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding: 20px 0; z-index: 1000; transform: translateX(-100%); transition: transform 0.3s; overflow-y: auto; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        .close-sidebar { background: none; border: none; font-size: 24px; cursor: pointer; }
        .sidebar-item { padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent; }
        .sidebar-item:active { background: #f0f0f0; }
        .sidebar-item.active { background: #f0f0f0; border-left-color: #667eea; }
        .card-container { background: white; border-radius: 25px; padding: 40px 20px; margin: 20px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.15); min-height: 250px; display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; transition: transform 0.3s; perspective: 1000px; }
        .card-container:active { transform: scale(0.98); }
        .card-inner { position: relative; width: 100%; height: 200px; transform-style: preserve-3d; transition: transform 0.6s; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: #667eea; word-wrap: break-word; padding: 20px; }
        .card-back { transform: rotateY(180deg); color: #764ba2; }
        .progress-container { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .progress-bar { background: #e0e0e0; height: 10px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.8; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 20px 0; }
        button { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 16px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        button:active { transform: scale(0.95); background: #764ba2; }
        button.secondary { background: #764ba2; }
        button.danger { background: #ff6b6b; }
        input, textarea, select { padding: 12px; border-radius: 10px; border: 2px solid #e0e0e0; margin: 10px 0; width: 100%; font-size: 16px; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 10px rgba(102, 126, 234, 0.2); }
        .form-group { margin-bottom: 20px; }
        .label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .deck-item { background: white; padding: 15px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .deck-item:active { background: #f5f5f5; }
        .deck-info { flex: 1; }
        .deck-name { font-weight: bold; font-size: 16px; }
        .deck-count { font-size: 12px; color: #999; margin-top: 5px; }
        .deck-actions { display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 8px; }
        .icon-btn:active { opacity: 0.6; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
        .overlay.show { display: block; }
        .modal { background: white; border-radius: 20px; padding: 30px; max-height: 90vh; overflow-y: auto; max-width: 600px; margin: 20px auto; }
        .modal-header { font-size: 22px; font-weight: bold; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; }
        .confetti { position: fixed; pointer-events: none; font-size: 30px; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .toggle { display: inline-flex; width: 50px; height: 28px; background: #e0e0e0; border-radius: 14px; border: none; cursor: pointer; position: relative; }
        .toggle.on { background: #667eea; }
        .toggle-dot { position: absolute; width: 24px; height: 24px; background: white; border-radius: 12px; top: 2px; left: 2px; transition: left 0.3s; }
        .toggle.on .toggle-dot { left: 24px; }
        @media (prefers-color-scheme: dark) {
            body { background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%); }
            .card-container { background: #1e1e2e; }
            .card-front, .card-back { color: #a0a0ff; }
            .modal { background: #1e1e2e; color: white; }
            .sidebar { background: #1e1e2e; color: white; }
            input, textarea, select { background: #2d2d44; color: white; border-color: #444; }
            .deck-item { background: #2d2d44; color: white; }
            header { background: rgba(0,0,0,0.3); color: white; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>Menu</span>
            <button class="close-sidebar" onclick="toggleSidebar()">‚úï</button>
        </div>
        <div class="sidebar-item active" onclick="showView('study')">üìö Study</div>
        <div class="sidebar-item" onclick="showView('decks')">üìã My Decks</div>
        <div class="sidebar-item" onclick="showView('create')">‚ûï Create Deck</div>
        <div class="sidebar-item" onclick="showView('import')">üì§ Import/Generate</div>
        <div class="sidebar-item" onclick="showView('settings')">‚öôÔ∏è Settings</div>
        <div class="sidebar-item" onclick="showView('about')">‚ÑπÔ∏è About</div>
    </div>

    <!-- Header -->
    <div class="container">
        <header>
            <button class="nav-btn" onclick="toggleSidebar()">‚ò∞</button>
            <h1>üß† Flashcards</h1>
            <button class="nav-btn" onclick="toggleDarkMode()" id="themeBtn">üåô</button>
        </header>

        <!-- Study View -->
        <div class="view active" id="study">
            <div class="progress-container">
                <h3 id="deckTitle" style="margin-bottom: 10px;">Select a Deck</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div style="text-align: center; font-size: 14px; color: #999; margin-top: 8px;">
                    <span id="currentCard">0</span> / <span id="totalCards">0</span>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Learned</div>
                        <div class="stat-value" id="learnedCount">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Remaining</div>
                        <div class="stat-value" id="remainingCount">0</div>
                    </div>
                </div>
            </div>

            <div class="card-container" onclick="flipCard()">
                <div class="card-inner" id="cardInner">
                    <div class="card-front" id="cardFront">Click to start studying</div>
                    <div class="card-back" id="cardBack"></div>
                </div>
            </div>

            <div class="button-group">
                <button class="secondary" onclick="skipCard()">Skip ‚è≠Ô∏è</button>
                <button onclick="markGood()">Easy üëç</button>
                <button class="danger" onclick="markAgain()">Hard üîÑ</button>
            </div>
        </div>

        <!-- Decks View -->
        <div class="view" id="decks">
            <h2 style="margin-bottom: 20px;">My Decks</h2>
            <div id="decksList"></div>
        </div>

        <!-- Create Deck View -->
        <div class="view" id="create">
            <h2 style="margin-bottom: 20px;">Create New Deck</h2>
            <div class="form-group">
                <label class="label">Deck Name</label>
                <input type="text" id="newDeckName" placeholder="e.g., Italian A1">
            </div>
            <button onclick="createNewDeck()" style="width: 100%;">Create Deck</button>
            <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">
            <h3 style="margin-bottom: 15px;">Add Cards</h3>
            <div class="form-group">
                <label class="label">Front (e.g., Italian)</label>
                <input type="text" id="cardFrontInput" placeholder="Ciao">
            </div>
            <div class="form-group">
                <label class="label">Back (e.g., English)</label>
                <input type="text" id="cardBackInput" placeholder="Hello">
            </div>
            <button onclick="addCardToDeck()" style="width: 100%;">Add Card</button>
            <div id="currentCardsPreview" style="margin-top: 20px;"></div>
        </div>

        <!-- Import/Generate View -->
        <div class="view" id="import">
            <h2 style="margin-bottom: 20px;">Import or Generate Decks</h2>
            <h3 style="margin: 20px 0 10px;">üì§ Import Deck</h3>
            <div class="form-group">
                <label class="label">Select File (CSV, JSON, or TXT)</label>
                <input type="file" id="fileInput" accept=".csv,.json,.txt">
            </div>
            <button onclick="importDeck()" style="width: 100%;">Import</button>

            <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

            <h3 style="margin: 20px 0 10px;">ü§ñ AI Generate Deck</h3>
            <div class="form-group">
                <label class="label">Topic (e.g., Italian Business Vocabulary)</label>
                <input type="text" id="aiTopic" placeholder="Italian food vocabulary">
            </div>
            <div class="form-group">
                <label class="label">OpenAI API Key (Optional - get free credits at platform.openai.com)</label>
                <input type="password" id="apiKey" placeholder="sk-...">
                <small style="color: #999; display: block; margin-top: 5px;">Leave blank to generate without AI (demo mode)</small>
            </div>
            <button onclick="generateDeck()" style="width: 100%;">Generate Deck</button>
            <div id="generatedPreview" style="margin-top: 20px;"></div>
        </div>

        <!-- Settings View -->
        <div class="view" id="settings">
            <h2 style="margin-bottom: 20px;">Settings</h2>
            <div class="form-group">
                <label class="label">Dark Mode</label>
                <button class="toggle" id="darkModeToggle" onclick="toggleDarkMode()">
                    <div class="toggle-dot"></div>
                </button>
            </div>
            <hr style="margin: 20px 0;">
            <h3 style="margin-bottom: 15px;">Data Management</h3>
            <button onclick="exportAllData()" style="width: 100%; margin-bottom: 10px;">üíæ Export All Data</button>
            <button onclick="clearAllData()" class="danger" style="width: 100%;">üóëÔ∏è Clear All Data</button>
        </div>

        <!-- About View -->
        <div class="view" id="about">
            <h2 style="margin-bottom: 20px;">About</h2>
            <p style="line-height: 1.8; color: #666;">
                <strong>Language Flashcard PWA</strong><br><br>
                A fast, offline-first flashcard app for language learning. Create, import, or generate decks. Study with spaced repetition algorithm. All data saved locally on your device.<br><br>
                <strong>Features:</strong><br>
                ‚úì Create custom decks<br>
                ‚úì Import CSV/JSON/TXT<br>
                ‚úì AI deck generation<br>
                ‚úì Offline support<br>
                ‚úì Progress tracking<br>
                ‚úì Dark mode<br><br>
                Works on iPhone Safari. Add to home screen for full app experience.
            </p>
        </div>
    </div>

    <script>
        // Data Management
        let decks = JSON.parse(localStorage.getItem('flashcardDecks') || '[]');
        let currentDeckIndex = -1;
        let currentCardIndex = 0;
        let learned = JSON.parse(localStorage.getItem('learnedCards') || '{}');
        let newDeckCards = [];

        function saveData() {
            localStorage.setItem('flashcardDecks', JSON.stringify(decks));
            localStorage.setItem('learnedCards', JSON.stringify(learned));
        }

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('show');
        }

        document.getElementById('overlay').addEventListener('click', toggleSidebar);

        // Theme Toggle
        function toggleDarkMode() {
            document.documentElement.style.colorScheme = document.documentElement.style.colorScheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('darkMode', document.documentElement.style.colorScheme);
            updateThemeButton();
        }

        function updateThemeButton() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Study Functions
        function updateStudyView() {
            if (currentDeckIndex < 0) {
                document.getElementById('cardFront').textContent = 'Select a deck to start';
                document.getElementById('cardBack').textContent = '';
                return;
            }
            const deck = decks[currentDeckIndex];
            document.getElementById('deckTitle').textContent = deck.name;
            const deckLearned = learned[currentDeckIndex] || [];
            document.getElementById('learnedCount').textContent = deckLearned.length;
            document.getElementById('remainingCount').textContent = deck.cards.length - deckLearned.length;
            document.getElementById('totalCards').textContent = deck.cards.length;
            document.getElementById('currentCard').textContent = currentCardIndex + 1;
            document.getElementById('progressFill').style.width = (deckLearned.length / deck.cards.length * 100) + '%';
            loadCard();
        }

        function loadCard() {
            if (currentDeckIndex < 0 || decks[currentDeckIndex].cards.length === 0) return;
            const deck = decks[currentDeckIndex];
            const deckLearned = learned[currentDeckIndex] || [];
            const unlearnedIndices = deck.cards.map((_, i) => i).filter(i => !deckLearned.includes(i));
            if (unlearnedIndices.length === 0) {
                document.getElementById('cardFront').textContent = 'üéâ Deck Complete!';
                document.getElementById('cardBack').textContent = 'All cards mastered!';
                playConfetti();
                return;
            }
            currentCardIndex = unlearnedIndices[Math.floor(Math.random() * unlearnedIndices.length)];
            const card = deck.cards[currentCardIndex];
            document.getElementById('cardFront').textContent = card.front;
            document.getElementById('cardBack').textContent = card.back;
            document.getElementById('cardInner').classList.remove('flipped');
        }

        function flipCard() {
            document.getElementById('cardInner').classList.toggle('flipped');
        }

        function skipCard() {
            loadCard();
        }

        function markGood() {
            if (currentDeckIndex < 0) return;
            if (!learned[currentDeckIndex]) learned[currentDeckIndex] = [];
            if (!learned[currentDeckIndex].includes(currentCardIndex)) {
                learned[currentDeckIndex].push(currentCardIndex);
            }
            saveData();
            playConfetti();
            loadCard();
            updateStudyView();
        }

        function markAgain() {
            loadCard();
        }

        // Deck Management
        function createNewDeck() {
            const name = document.getElementById('newDeckName').value.trim();
            if (!name) { alert('Please enter a deck name'); return; }
            decks.push({ name, cards: [] });
            learned[decks.length - 1] = [];
            saveData();
            alert('Deck created! Now add cards.');
            document.getElementById('newDeckName').value = '';
            updateDecksList();
        }

        function addCardToDeck() {
            const front = document.getElementById('cardFrontInput').value.trim();
            const back = document.getElementById('cardBackInput').value.trim();
            if (!front || !back) { alert('Please fill both fields'); return; }
            if (currentDeckIndex < 0) { alert('Create a deck first'); return; }
            decks[currentDeckIndex].cards.push({ front, back });
            saveData();
            document.getElementById('cardFrontInput').value = '';
            document.getElementById('cardBackInput').value = '';
            updateCurrentCardsPreview();
            updateStudyView();
        }

        function updateCurrentCardsPreview() {
            if (currentDeckIndex < 0) return;
            const preview = decks[currentDeckIndex].cards.map((c, i) => 
                `<div class="deck-item"><div class="deck-info"><div class="deck-name">${c.front}</div><div class="deck-count">${c.back}</div></div><button class="icon-btn" onclick="removeCard(${i})">‚úï</button></div>`
            ).join('');
            document.getElementById('currentCardsPreview').innerHTML = preview ? `<h4>Cards in ${decks[currentDeckIndex].name}:</h4>${preview}` : '';
        }

        function removeCard(index) {
            if (currentDeckIndex < 0) return;
            decks[currentDeckIndex].cards.splice(index, 1);
            saveData();
            updateCurrentCardsPreview();
        }

        function updateDecksList() {
            const html = decks.map((deck, i) => {
                const deckLearned = (learned[i] || []).length;
                return `<div class="deck-item" onclick="selectDeck(${i}); showView('study')">
                    <div class="deck-info">
                        <div class="deck-name">${deck.name}</div>
                        <div class="deck-count">${deck.cards.length} cards ‚Ä¢ ${deckLearned} learned</div>
                    </div>
                    <div class="deck-actions">
                        <button class="icon-btn" onclick="event.stopPropagation(); editDeck(${i})">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteDeck(${i})">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('decksList').innerHTML = html || '<p style="color: #999; text-align: center;">No decks yet. Create one!</p>';
        }

        function selectDeck(index) {
            currentDeckIndex = index;
            updateStudyView();
        }

        function deleteDeck(index) {
            if (confirm('Delete this deck?')) {
                decks.splice(index, 1);
                delete learned[index];
                saveData();
                updateDecksList();
                currentDeckIndex = -1;
            }
        }

        // Import/Export
        function importDeck() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) { alert('Select a file'); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    let cards = [];
                    if (file.name.endsWith('.csv')) {
                        cards = content.split('\n').slice(1).filter(line => line.trim()).map(line => {
                            const [front, back] = line.split(',').map(s => s.trim());
                            return { front, back };
                        });
                    } else if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        if (Array.isArray(data)) cards = data;
                        else if (data.cards) cards = data.cards;
                    } else if (file.name.endsWith('.txt')) {
                        cards = content.split('\n').filter(line => line.trim()).map((line, i) => ({
                            front: i % 2 === 0 ? line : cards[Math.floor(i/2)].front,
                            back: i % 2 === 1 ? line : ''
                        })).filter(c => c.front && c.back);
                    }
                    const deckName = file.name.replace(/\.[^/.]+$/, '');
                    decks.push({ name: deckName, cards });
                    learned[decks.length - 1] = [];
                    saveData();
                    alert(`Imported ${cards.length} cards!`);
                    updateDecksList();
                    document.getElementById('fileInput').value = '';
                } catch (err) {
                    alert('Error importing file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function generateDeck() {
            const topic = document.getElementById('aiTopic').value.trim();
            if (!topic) { alert('Enter a topic'); return; }
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                const demoCards = [
                    { front: 'Ciao', back: 'Hello' },
                    { front: 'Grazie', back: 'Thank you' },
                    { front: 'Per favore', back: 'Please' },
                    { front: 'Scusa', back: 'Excuse me' }
                ];
                showGeneratedPreview(demoCards, topic);
                return;
            }
            fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: `Generate 20 flashcard pairs for learning: "${topic}". Format: Front|Back, one per line.` }]
                })
            }).then(r => r.json()).then(data => {
                const content = data.choices[0].message.content;
                const cards = content.split('\n').filter(line => line.includes('|')).slice(0, 20).map(line => {
                    const [front, back] = line.split('|').map(s => s.trim());
                    return { front, back };
                });
                showGeneratedPreview(cards, topic);
            }).catch(err => alert('Error: ' + err.message));
        }

        function showGeneratedPreview(cards, topic) {
            const html = `<div><h4>Preview: ${topic} (${cards.length} cards)</h4>` + 
                cards.map(c => `<div class="deck-item"><div class="deck-info"><div class="deck-name">${c.front}</div><div class="deck-count">${c.back}</div></div></div>`).join('') + 
                `<button onclick="saveGeneratedDeck('${topic}', ${JSON.stringify(cards).replace(/'/g, "&apos;")})">Save Deck</button></div>`;
            document.getElementById('generatedPreview').innerHTML = html;
        }

        function saveGeneratedDeck(name, cards) {
            decks.push({ name, cards });
            learned[decks.length - 1] = [];
            saveData();
            alert('Deck saved!');
            updateDecksList();
            document.getElementById('aiTopic').value = '';
            document.getElementById('generatedPreview').innerHTML = '';
        }

        function exportAllData() {
            const data = { decks, learned, exported: new Date().toISOString() };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flashcards-backup-${Date.now()}.json`;
            a.click();
        }

        function clearAllData() {
            if (confirm('Delete ALL decks and progress?')) {
                localStorage.clear();
                decks = [];
                learned = {};
                currentDeckIndex = -1;
                updateDecksList();
                updateStudyView();
                alert('All data cleared');
            }
        }

        // UI Effects
        function playConfetti() {
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = ['üéâ', '‚≠ê', 'üéä', '‚ú®'][Math.floor(Math.random() * 4)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-20px';
                confetti.style.opacity = Math.random() * 0.5 + 0.5;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // Initialize
        updateDarkMode();
        updateDecksList();
        updateThemeButton();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript,self.addEventListener("install",e=>self.skipWaiting());self.addEventListener("activate",e=>self.clients.claim());');
        }
    </script>
</body>
</html>
